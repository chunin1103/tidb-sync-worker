{% extends "wiki_base.html" %}

{% block title %}Decision Tree Visualizer{% endblock %}

{% block extra_head %}
<link rel="stylesheet" href="{{ url_for('wiki.static', filename='decision_tree.css') }}">
{% endblock %}

{% block content %}
<div class="dt-page">
    <!-- Top Header -->
    <header class="dt-header">
        <div class="dt-header-content">
            <div class="dt-title-group">
                <h1>Interactive Decision Tree Visualizer</h1>
                <p class="dt-subtitle">One Tree, Many Configurations - Live path tracing with vendor-specific parameters</p>
            </div>
            <div class="dt-tree-selector">
                <label for="tree-select">Decision Tree:</label>
                <select id="tree-select" class="dt-select">
                    {% for tree in tree_list %}
                    <option value="{{ tree.id }}" {% if tree.id == default_tree_id %}selected{% endif %}>
                        {{ tree.title }} ({{ tree.node_count }} nodes)
                    </option>
                    {% endfor %}
                </select>
            </div>
        </div>
    </header>

    <div class="dt-layout">
        <!-- LEFT SIDEBAR -->
        <aside class="dt-sidebar">
            <!-- Vendor Selection Cards -->
            <section class="dt-section">
                <h3><span class="section-icon">1</span> Select Vendor</h3>
                <div class="vendor-cards" id="vendor-cards">
                    {% for vendor in vendors %}
                    <button class="vendor-card" data-vendor-id="{{ vendor.id }}" data-color="{{ vendor.color }}">
                        <span class="vendor-dot" style="background: {{ vendor.color }}"></span>
                        <span class="vendor-name">{{ vendor.name }}</span>
                    </button>
                    {% endfor %}
                </div>
                <p class="dt-hint" id="vendor-hint">Select a vendor to apply their specific thresholds</p>
            </section>

            <!-- Active Rules Display -->
            <section class="dt-section dt-rules-section" id="rules-section" style="display: none;">
                <h3><span class="section-icon">2</span> Active Parameters</h3>
                <div class="rules-container">
                    <div class="rules-grid" id="rules-grid">
                        <!-- Populated dynamically when vendor is selected -->
                    </div>
                </div>
            </section>

            <!-- Test Inputs with Sliders -->
            <section class="dt-section dt-inputs-section" id="inputs-section" style="display: none;">
                <h3><span class="section-icon">3</span> Simulation Inputs</h3>

                <div class="input-slider-group">
                    <div class="slider-header">
                        <label for="input-quantity">Quantity in Stock</label>
                        <span class="slider-value" id="qty-value">50</span>
                    </div>
                    <input type="range" id="input-quantity" class="dt-slider"
                           min="0" max="500" value="50" step="1">
                    <div class="slider-labels">
                        <span>0</span>
                        <span>250</span>
                        <span>500</span>
                    </div>
                </div>

                <div class="input-slider-group">
                    <div class="slider-header">
                        <label for="input-purchased">Annual Purchased</label>
                        <span class="slider-value" id="purchased-value">100</span>
                    </div>
                    <input type="range" id="input-purchased" class="dt-slider"
                           min="0" max="1000" value="100" step="1">
                    <div class="slider-labels">
                        <span>0</span>
                        <span>500</span>
                        <span>1000</span>
                    </div>
                </div>

                <!-- Calculated Values -->
                <div class="calculated-values">
                    <div class="calc-row">
                        <span class="calc-label">Years in Stock (YIS)</span>
                        <span class="calc-result" id="calc-yis">0.50</span>
                    </div>
                    <div class="calc-row secondary">
                        <span class="calc-label">Days Coverage</span>
                        <span class="calc-result" id="calc-days">183 days</span>
                    </div>
                    <div class="yis-bar-container">
                        <div class="yis-bar" id="yis-bar" style="width: 50%"></div>
                        <div class="yis-threshold threshold-low" id="threshold-low" style="left: 25%"></div>
                        <div class="yis-threshold threshold-target" id="threshold-target" style="left: 40%"></div>
                    </div>
                    <div class="yis-legend">
                        <span class="legend-item"><span class="dot red"></span>Below threshold</span>
                        <span class="legend-item"><span class="dot yellow"></span>OK</span>
                        <span class="legend-item"><span class="dot green"></span>At/above target</span>
                    </div>
                </div>
            </section>

            <!-- Result Display -->
            <section class="dt-section dt-result-section" id="result-section" style="display: none;">
                <h3><span class="section-icon">4</span> Decision Result</h3>
                <div id="result-display" class="result-box">
                    <div class="result-action" id="result-action">--</div>
                    <div class="result-details">
                        <div class="result-row">
                            <span class="result-label">Priority</span>
                            <span class="result-value" id="result-priority">--</span>
                        </div>
                        <div class="result-row" id="reorder-row" style="display: none;">
                            <span class="result-label">Reorder Qty</span>
                            <span class="result-value" id="result-reorder">--</span>
                        </div>
                    </div>
                    <div class="result-reason" id="result-reason">Select a vendor and adjust inputs to trace path</div>
                </div>
            </section>

            <!-- Path Summary -->
            <section class="dt-section dt-path-section" id="path-section" style="display: none;">
                <h3><span class="section-icon">5</span> Path Trace</h3>
                <div class="path-summary" id="path-summary">
                    <!-- Shows the sequence of nodes visited -->
                </div>
            </section>

            <!-- Feedback Summary -->
            <section class="dt-section dt-feedback-summary-section" id="feedback-summary-section">
                <h3><span class="section-icon">!</span> Feedback</h3>
                <div class="feedback-summary">
                    <span id="feedback-count">{{ feedback_counts|length }}</span> nodes with comments
                    <span class="unresolved-badge" id="unresolved-badge" style="{% if not feedback_counts %}display:none{% endif %}">
                        {{ feedback_counts.values()|sum if feedback_counts else 0 }} unresolved
                    </span>
                </div>
            </section>
        </aside>

        <!-- MAIN CANVAS -->
        <main class="dt-canvas">
            <!-- Canvas Toolbar -->
            <div class="canvas-toolbar">
                <div class="toolbar-left">
                    <span class="toolbar-label" id="canvas-label">Select a vendor to begin</span>
                    <span class="live-indicator" id="live-indicator" style="display: none;">
                        <span class="live-dot"></span> LIVE
                    </span>
                </div>
                <div class="toolbar-center">
                    <div class="zoom-display" id="zoom-display">100%</div>
                </div>
                <div class="toolbar-right">
                    <button id="btn-zoom-out" class="toolbar-btn" title="Zoom Out">
                        <svg width="16" height="16" viewBox="0 0 16 16" fill="currentColor">
                            <path d="M3 8h10" stroke="currentColor" stroke-width="2" fill="none"/>
                        </svg>
                    </button>
                    <button id="btn-zoom-in" class="toolbar-btn" title="Zoom In">
                        <svg width="16" height="16" viewBox="0 0 16 16" fill="currentColor">
                            <path d="M8 3v10M3 8h10" stroke="currentColor" stroke-width="2" fill="none"/>
                        </svg>
                    </button>
                    <button id="btn-reset-view" class="toolbar-btn" title="Reset View">
                        <svg width="16" height="16" viewBox="0 0 16 16" fill="currentColor">
                            <path d="M2 8a6 6 0 1 1 1.5 4" stroke="currentColor" stroke-width="1.5" fill="none"/>
                            <path d="M2 12V8h4" stroke="currentColor" stroke-width="1.5" fill="none"/>
                        </svg>
                    </button>
                    <button id="btn-fit-view" class="toolbar-btn" title="Fit to View">
                        <svg width="16" height="16" viewBox="0 0 16 16" fill="currentColor">
                            <rect x="2" y="2" width="12" height="12" stroke="currentColor" stroke-width="1.5" fill="none" rx="1"/>
                            <rect x="5" y="5" width="6" height="6" fill="currentColor" rx="0.5"/>
                        </svg>
                    </button>
                </div>
            </div>

            <!-- SVG Container -->
            <div class="canvas-container" id="canvas-container">
                <svg id="decision-tree-svg" viewBox="0 0 1200 1600" preserveAspectRatio="xMidYMid meet">
                    <defs>
                        <!-- Arrow markers -->
                        <marker id="arrowhead" markerWidth="10" markerHeight="7"
                                refX="9" refY="3.5" orient="auto" fill="#9e9e9e">
                            <polygon points="0 0, 10 3.5, 0 7" />
                        </marker>
                        <marker id="arrowhead-active" markerWidth="10" markerHeight="7"
                                refX="9" refY="3.5" orient="auto" fill="#3f51b5">
                            <polygon points="0 0, 10 3.5, 0 7" />
                        </marker>
                        <marker id="arrowhead-success" markerWidth="10" markerHeight="7"
                                refX="9" refY="3.5" orient="auto" fill="#4caf50">
                            <polygon points="0 0, 10 3.5, 0 7" />
                        </marker>
                        <marker id="arrowhead-danger" markerWidth="10" markerHeight="7"
                                refX="9" refY="3.5" orient="auto" fill="#f44336">
                            <polygon points="0 0, 10 3.5, 0 7" />
                        </marker>

                        <!-- Glow filter for active nodes -->
                        <filter id="glow" x="-50%" y="-50%" width="200%" height="200%">
                            <feGaussianBlur in="SourceGraphic" stdDeviation="3" result="blur"/>
                            <feMerge>
                                <feMergeNode in="blur"/>
                                <feMergeNode in="SourceGraphic"/>
                            </feMerge>
                        </filter>

                        <!-- Pulse animation for active path -->
                        <filter id="pulse" x="-50%" y="-50%" width="200%" height="200%">
                            <feGaussianBlur in="SourceGraphic" stdDeviation="2" result="blur"/>
                            <feColorMatrix in="blur" type="matrix" values="1 0 0 0 0  0 1 0 0 0  0 0 1 0 0  0 0 0 18 -7" result="glow"/>
                            <feMerge>
                                <feMergeNode in="glow"/>
                                <feMergeNode in="SourceGraphic"/>
                            </feMerge>
                        </filter>

                        <!-- Drop shadow for nodes -->
                        <filter id="shadow" x="-20%" y="-20%" width="140%" height="140%">
                            <feDropShadow dx="1" dy="2" stdDeviation="2" flood-opacity="0.15"/>
                        </filter>

                        <!-- Gradient for start node -->
                        <linearGradient id="start-gradient" x1="0%" y1="0%" x2="100%" y2="100%">
                            <stop offset="0%" style="stop-color:#4caf50;stop-opacity:1" />
                            <stop offset="100%" style="stop-color:#2e7d32;stop-opacity:1" />
                        </linearGradient>

                        <!-- Gradient for decision node -->
                        <linearGradient id="decision-gradient" x1="0%" y1="0%" x2="100%" y2="100%">
                            <stop offset="0%" style="stop-color:#5c6bc0;stop-opacity:1" />
                            <stop offset="100%" style="stop-color:#3f51b5;stop-opacity:1" />
                        </linearGradient>
                    </defs>

                    <!-- Background grid (subtle) -->
                    <g id="grid-layer" class="grid-layer">
                        <pattern id="grid-pattern" width="50" height="50" patternUnits="userSpaceOnUse">
                            <path d="M 50 0 L 0 0 0 50" fill="none" stroke="rgba(0,0,0,0.03)" stroke-width="1"/>
                        </pattern>
                        <rect width="100%" height="100%" fill="url(#grid-pattern)" />
                    </g>

                    <!-- Edges layer (behind nodes) -->
                    <g id="edges-layer" class="edges-layer"></g>

                    <!-- Nodes layer -->
                    <g id="nodes-layer" class="nodes-layer"></g>

                    <!-- Labels layer (on top) -->
                    <g id="labels-layer" class="labels-layer"></g>

                    <!-- Feedback indicators layer -->
                    <g id="feedback-layer" class="feedback-layer"></g>
                </svg>

                <!-- Empty state message -->
                <div class="empty-state" id="empty-state">
                    <div class="empty-icon">
                        <svg width="64" height="64" viewBox="0 0 64 64" fill="none" stroke="#9e9e9e" stroke-width="2">
                            <circle cx="32" cy="12" r="8"/>
                            <line x1="32" y1="20" x2="32" y2="28"/>
                            <path d="M 16 40 L 32 28 L 48 40"/>
                            <circle cx="16" cy="48" r="6"/>
                            <circle cx="48" cy="48" r="6"/>
                            <line x1="16" y1="40" x2="16" y2="42"/>
                            <line x1="48" y1="40" x2="48" y2="42"/>
                        </svg>
                    </div>
                    <h3>Decision Tree Visualizer</h3>
                    <p>Select a vendor from the sidebar to load the decision tree with their specific parameters.</p>
                    <p class="empty-hint">The tree structure remains the same - only the threshold values change!</p>
                </div>
            </div>

            <!-- Node Detail Panel (floating) -->
            <div id="node-detail-panel" class="node-detail" style="display: none;">
                <div class="node-detail-header">
                    <h4 id="detail-title">Node Title</h4>
                    <button class="close-btn" id="close-detail">&times;</button>
                </div>
                <div class="node-detail-body">
                    <p id="detail-description">Node description...</p>
                    <div id="detail-condition" class="detail-condition"></div>
                    <div id="detail-result" class="detail-result"></div>
                </div>
                <div class="node-detail-feedback" id="node-feedback-section">
                    <div class="feedback-header">
                        <span>Comments</span>
                        <span class="feedback-count" id="detail-feedback-count">0</span>
                    </div>
                    <div class="feedback-list" id="detail-feedback-list">
                        <!-- Comments populated here -->
                    </div>
                    <div class="feedback-form">
                        <input type="text" id="feedback-author" placeholder="Your name" class="feedback-input">
                        <textarea id="feedback-text" placeholder="Add a comment..." class="feedback-textarea"></textarea>
                        <button id="btn-add-feedback" class="btn-add-feedback">Add Comment</button>
                    </div>
                </div>
            </div>

            <!-- Legend -->
            <div class="canvas-legend">
                <div class="legend-title">Node Types</div>
                <div class="legend-items">
                    <div class="legend-item">
                        <span class="legend-shape start"></span>
                        <span>Start</span>
                    </div>
                    <div class="legend-item">
                        <span class="legend-shape decision"></span>
                        <span>Decision</span>
                    </div>
                    <div class="legend-item">
                        <span class="legend-shape calculation"></span>
                        <span>Calculation</span>
                    </div>
                    <div class="legend-item">
                        <span class="legend-shape action"></span>
                        <span>Action</span>
                    </div>
                    <div class="legend-item">
                        <span class="legend-shape result"></span>
                        <span>Result</span>
                    </div>
                </div>
                <div class="legend-divider"></div>
                <div class="legend-items">
                    <div class="legend-item">
                        <span class="legend-line active"></span>
                        <span>Active Path</span>
                    </div>
                    <div class="legend-item">
                        <span class="legend-line inactive"></span>
                        <span>Inactive</span>
                    </div>
                    <div class="legend-item">
                        <span class="legend-dot feedback"></span>
                        <span>Has Feedback</span>
                    </div>
                </div>
            </div>
        </main>
    </div>
</div>

<!-- Embed data for JS -->
<script>
    window.DECISION_TREE_DATA = {{ tree | tojson | safe }};
    window.FEEDBACK_COUNTS = {{ feedback_counts | tojson | safe }};
    window.DEFAULT_TREE_ID = {{ default_tree_id | tojson | safe }};
</script>
{% endblock %}

{% block scripts %}
<script src="{{ url_for('wiki.static', filename='decision_tree.js') }}"></script>
{% endblock %}
