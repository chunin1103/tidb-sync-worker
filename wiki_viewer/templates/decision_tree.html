{% extends "wiki_base.html" %}

{% block title %}Reorder Logic System{% endblock %}

{% block extra_head %}
<link rel="stylesheet" href="{{ url_for('wiki.static', filename='decision_tree.css') }}">
{% endblock %}

{% block content %}
<div class="dt-app">
    <!-- Top Bar -->
    <header class="dt-topbar">
        <div class="dt-brand">
            <div class="dt-logo">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <circle cx="6" cy="6" r="3"/><circle cx="18" cy="18" r="3"/>
                    <path d="M6 21V9a9 9 0 0 0 9 9h6"/>
                </svg>
            </div>
            <div class="dt-title">
                <h1>Reorder Logic System</h1>
                <span class="dt-subtitle">One Tree, Many Configurations</span>
            </div>
        </div>

        <div class="dt-mode-tabs">
            <button class="mode-tab active" data-mode="simulation">
                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <polygon points="5 3 19 12 5 21 5 3"/>
                </svg>
                Simulation
            </button>
            <button class="mode-tab" data-mode="logic_editor">
                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <polyline points="16 18 22 12 16 6"/><polyline points="8 6 2 12 8 18"/>
                </svg>
                Master Logic
            </button>
            <button class="mode-tab" data-mode="vendor_editor">
                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/>
                    <circle cx="9" cy="7" r="4"/><path d="M23 21v-2a4 4 0 0 0-3-3.87"/>
                    <path d="M16 3.13a4 4 0 0 1 0 7.75"/>
                </svg>
                Vendor Config
            </button>
        </div>
    </header>

    <div class="dt-main">
        <!-- SIMULATION VIEW -->
        <div id="simulation-view" class="dt-view active">
            <!-- Left Sidebar -->
            <aside class="dt-sidebar">
                <!-- 1. Select Vendor -->
                <div class="sidebar-section">
                    <h2 class="section-title">1. Select Vendor</h2>
                    <div class="vendor-grid" id="vendor-grid">
                        {% for vendor in vendors %}
                        <button class="vendor-btn" data-vendor-id="{{ vendor.id }}">
                            {{ vendor.name }}
                        </button>
                        {% endfor %}
                    </div>
                </div>

                <!-- 2. Active Rules -->
                <div class="sidebar-section rules-section" id="rules-section" style="display: none;">
                    <h2 class="section-title">
                        <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <circle cx="12" cy="12" r="3"/><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"/>
                        </svg>
                        Active Rules: <span id="active-vendor-name">--</span>
                    </h2>
                    <div class="rules-box">
                        <div class="rule-row">
                            <span class="rule-label">Threshold:</span>
                            <span class="rule-value" id="rule-threshold">--</span>
                        </div>
                        <div class="rule-row">
                            <span class="rule-label">Cascade Allowed:</span>
                            <span class="rule-value" id="rule-cascade">--</span>
                        </div>
                    </div>
                </div>

                <!-- 3. Test Data -->
                <div class="sidebar-section" id="inputs-section" style="display: none;">
                    <h2 class="section-title">2. Test Data</h2>

                    <div class="input-group">
                        <div class="input-header">
                            <label>Years in Stock</label>
                            <span class="input-value" id="yis-value">0.15</span>
                        </div>
                        <input type="range" id="yis-slider" class="slider" min="0" max="0.6" step="0.05" value="0.15">
                    </div>

                    <div class="toggle-group">
                        <span class="toggle-label">Has Larger Sheets?</span>
                        <button class="toggle-btn active" id="cascade-toggle">
                            <span class="toggle-knob"></span>
                        </button>
                    </div>
                </div>
            </aside>

            <!-- Main Canvas -->
            <main class="dt-canvas">
                <div class="canvas-wrapper">
                    <!-- Grid Background -->
                    <div class="canvas-grid"></div>

                    <!-- SVG Tree - Larger viewBox for comprehensive tree -->
                    <svg id="tree-svg" class="tree-svg" viewBox="0 0 1200 1400">
                        <defs>
                            <marker id="arrow-active" markerWidth="10" markerHeight="7" refX="28" refY="3.5" orient="auto">
                                <polygon points="0 0, 10 3.5, 0 7" fill="#4f46e5"/>
                            </marker>
                            <marker id="arrow-inactive" markerWidth="10" markerHeight="7" refX="28" refY="3.5" orient="auto">
                                <polygon points="0 0, 10 3.5, 0 7" fill="#e2e8f0"/>
                            </marker>
                        </defs>
                        <g id="edges-layer"></g>
                        <g id="nodes-layer"></g>
                    </svg>
                </div>
            </main>
        </div>

        <!-- LOGIC EDITOR VIEW -->
        <div id="logic-view" class="dt-view editor-view">
            <div class="editor-header">
                <div class="editor-info">
                    <h2>master_logic.json</h2>
                    <p>Define the shape of the decision tree. Variables like {threshold_years} are resolved at runtime.</p>
                </div>
                <button class="btn-apply" id="btn-apply-logic">
                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"/>
                        <polyline points="17 21 17 13 7 13 7 21"/><polyline points="7 3 7 8 15 8"/>
                    </svg>
                    Apply Changes
                </button>
            </div>
            <div class="editor-body">
                <textarea id="logic-editor" class="code-editor" spellcheck="false"></textarea>
            </div>
            <div class="editor-error" id="logic-error" style="display: none;"></div>
        </div>

        <!-- VENDOR EDITOR VIEW -->
        <div id="vendor-view" class="dt-view editor-view">
            <div class="editor-header">
                <div class="editor-info">
                    <h2>vendors.json</h2>
                    <p>Configure parameters for each vendor. These values replace placeholders in the master logic.</p>
                </div>
                <button class="btn-apply" id="btn-apply-vendors">
                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"/>
                        <polyline points="17 21 17 13 7 13 7 21"/><polyline points="7 3 7 8 15 8"/>
                    </svg>
                    Apply Changes
                </button>
            </div>
            <div class="editor-body">
                <textarea id="vendor-editor" class="code-editor" spellcheck="false"></textarea>
            </div>
            <div class="editor-error" id="vendor-error" style="display: none;"></div>
        </div>
    </div>
</div>

<!-- Initial Data - Loaded from backend JSON files -->
<script>
// Convert nodes object to array format and normalize positions to percentages
function convertTreeFormat(treeData) {
    if (!treeData || !treeData.tree) return { nodes: [], edges: [] };

    const tree = treeData.tree;
    const nodesObj = tree.nodes || {};
    const edges = tree.edges || [];

    // Find position bounds for normalization
    let minX = Infinity, maxX = -Infinity, minY = Infinity, maxY = -Infinity;
    Object.values(nodesObj).forEach(node => {
        const pos = node.position || { x: 0, y: 0 };
        if (pos.x < minX) minX = pos.x;
        if (pos.x > maxX) maxX = pos.x;
        if (pos.y < minY) minY = pos.y;
        if (pos.y > maxY) maxY = pos.y;
    });

    // Add padding
    const rangeX = (maxX - minX) || 1;
    const rangeY = (maxY - minY) || 1;
    const padX = rangeX * 0.1;
    const padY = rangeY * 0.1;

    // Convert nodes to array with normalized positions (5-95% range)
    const nodes = Object.entries(nodesObj).map(([id, node]) => {
        const pos = node.position || { x: 50, y: 50 };
        return {
            id: id,
            label: node.label || id,
            type: node.type || 'decision',
            description: node.description || '',
            phase: node.phase || 'analysis',
            // Normalize to 5-95% range
            x: 5 + ((pos.x - minX + padX) / (rangeX + 2*padX)) * 90,
            y: 5 + ((pos.y - minY + padY) / (rangeY + 2*padY)) * 90
        };
    });

    return { nodes, edges };
}

// Load master logic from backend
{% if tree and tree.tree %}
window.MASTER_LOGIC = convertTreeFormat({{ tree | tojson | safe }});
{% else %}
// Fallback simple tree
window.MASTER_LOGIC = {
    nodes: [
        { id: "START", label: "Start Evaluation", type: "start", x: 50, y: 5 },
        { id: "check_stock", label: "Stock < Vendor Threshold?", type: "decision", x: 50, y: 30 },
        { id: "stock_ok", label: "Stock Sufficient", type: "result", x: 80, y: 50 },
        { id: "check_cascade", label: "Can Cascade?", type: "decision", x: 20, y: 50 },
        { id: "cut_sheet", label: "Generate Cut Sheet", type: "result", x: 5, y: 80 },
        { id: "place_order", label: "Place Vendor Order", type: "result", x: 35, y: 80 }
    ],
    edges: [
        { id: "e1", from: "START", to: "check_stock" },
        { id: "e2", from: "check_stock", to: "stock_ok", label: "High Stock (>= {threshold_years})", condition: { field: "yearsInStock", operator: ">=", value: "{threshold_years}" } },
        { id: "e3", from: "check_stock", to: "check_cascade", label: "Low Stock (< {threshold_years})", condition: { field: "yearsInStock", operator: "<", value: "{threshold_years}" } },
        { id: "e4", from: "check_cascade", to: "cut_sheet", label: "Cascade Possible", condition: { complex_logic: "cascade_check" } },
        { id: "e5", from: "check_cascade", to: "place_order", label: "Must Buy", condition: { complex_logic: "fallback" } }
    ]
};
{% endif %}

// Dynamically generated from backend vendor data
window.VENDORS = {
    {% for vendor_id, vendor_data in vendor_details.items() %}
    "{{ vendor_id }}": {
        name: "{{ vendor_data.name | default(vendor_id) }}",
        description: "{{ vendor_data.description | default('') }}",
        threshold_years: {{ vendor_data.parameters.threshold_years if vendor_data.parameters else 0.30 }},
        target_years: {{ vendor_data.parameters.target_years if vendor_data.parameters else 0.35 }},
        lean_threshold: {{ vendor_data.parameters.lean_threshold if vendor_data.parameters else 0.15 }},
        well_stocked_threshold: {{ vendor_data.parameters.well_stocked_threshold if vendor_data.parameters else 0.40 }},
        overstocked_threshold: {{ vendor_data.parameters.overstocked_threshold if vendor_data.parameters else 0.50 }},
        source_min_yis: {{ vendor_data.parameters.source_min_yis if vendor_data.parameters else 0.20 }},
        allow_cascade: {{ 'true' if vendor_data.parameters and vendor_data.parameters.allow_cascade else 'false' }},
        has_special_rules: {{ 'true' if vendor_data.parameters and vendor_data.parameters.has_special_rules else 'false' }},
        rounding_multiple: {{ vendor_data.parameters.rounding_multiple if vendor_data.parameters and vendor_data.parameters.rounding_multiple else 1 }},
        zero_stock_bonus: {{ vendor_data.parameters.zero_stock_bonus if vendor_data.parameters and vendor_data.parameters.zero_stock_bonus else 0 }},
        color: "{{ vendor_data.display.color if vendor_data.display else '#616161' }}"
    }{% if not loop.last %},{% endif %}
    {% endfor %}
};

console.log('Loaded MASTER_LOGIC:', window.MASTER_LOGIC);
console.log('Loaded VENDORS:', window.VENDORS);
</script>
{% endblock %}

{% block scripts %}
<script src="{{ url_for('wiki.static', filename='decision_tree.js') }}"></script>
{% endblock %}
